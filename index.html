<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor AI - Gemini Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .turn-active { border: 2px solid #6366f1; background: rgba(99, 102, 241, 0.1); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .hidden { display: none !important; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .error-pulse { animation: pulse-red 2s infinite; color: #ef4444; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="app" class="max-w-4xl w-full">
        <div id="status-bar" class="fixed top-0 left-0 w-full bg-slate-900 border-b border-white/10 text-center text-[10px] font-mono py-1 z-50 flex justify-center gap-4">
            <span>SISTEMA: <span id="status-text" class="text-indigo-400">CONECTANDO</span></span>
            <span id="ai-debug" class="text-slate-500">GEMINI: ESPERANDO</span>
        </div>

        <div id="view-loading" class="py-24 text-center space-y-6">
            <div class="relative inline-block">
                <div class="h-16 w-16 rounded-full border-4 border-indigo-500/20 border-t-indigo-500 animate-spin"></div>
            </div>
            <p id="loading-text" class="text-slate-400 font-bold uppercase tracking-widest text-xs">Inicializando Núcleo...</p>
        </div>

        <div id="view-setup" class="hidden py-12 text-center space-y-8">
            <div class="space-y-2">
                <h1 class="text-6xl font-black italic tracking-tighter text-white">IMPOSTOR <span class="text-indigo-500">AI</span></h1>
                <p class="text-slate-500 text-sm">Powered by Gemini 1.5 Flash</p>
            </div>
            
            <div class="glass p-8 rounded-[2rem] max-w-sm mx-auto space-y-6 shadow-2xl">
                <div class="text-left space-y-1">
                    <label class="text-[10px] uppercase font-bold text-slate-500 ml-1">Tu Identidad</label>
                    <input type="text" id="player-name" value="Agente Humano" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl outline-none focus:border-indigo-500 transition-all text-sm">
                </div>
                <button id="btn-create" class="w-full bg-indigo-600 hover:bg-indigo-500 p-5 rounded-2xl font-black text-sm tracking-widest shadow-lg shadow-indigo-500/20 transition-all active:scale-95">
                    INICIAR SIMULACIÓN
                </button>
            </div>
        </div>

        <div id="view-game" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 py-8">
            <div class="lg:col-span-4 space-y-4">
                <div class="glass p-6 rounded-[2rem]">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6 border-b border-white/5 pb-2">Red de Agentes</h3>
                    <div id="player-list" class="space-y-3"></div>
                </div>

                <div id="role-card" class="glass p-6 rounded-[2rem] border-l-4 border-indigo-600 cursor-pointer group transition-all hover:bg-white/[0.02]">
                    <div class="flex justify-between items-start">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Información Clasificada</p>
                        <span class="text-[10px] bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded-full">Oculto</span>
                    </div>
                    <div id="role-reveal" class="mt-4 font-black text-2xl blur-md group-hover:blur-0 transition-all duration-500 uppercase tracking-widest">???</div>
                    <p id="role-word" class="text-sm text-slate-400 mt-2 opacity-0 group-hover:opacity-100 italic transition-all">Sincronizando...</p>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-4">
                <div class="glass h-[500px] rounded-[2.5rem] flex flex-col overflow-hidden relative border border-white/5">
                    <div id="chat-feed" class="flex-1 p-8 overflow-y-auto chat-scroll space-y-6"></div>
                    
                    <div id="ai-status-indicator" class="px-8 py-2 bg-slate-900/50 flex items-center gap-3 hidden border-t border-white/5">
                        <div class="h-2 w-2 bg-indigo-500 rounded-full animate-ping"></div>
                        <span id="ai-status-msg" class="text-[10px] font-bold text-indigo-400 uppercase">Gemini está pensando...</span>
                    </div>

                    <div id="input-container" class="p-6 bg-slate-950/50 border-t border-white/5 flex gap-3">
                        <input type="text" id="word-input" placeholder="Tu turno..." class="flex-1 bg-slate-900 border border-slate-800 p-4 rounded-2xl outline-none focus:border-indigo-500 text-sm disabled:opacity-30" disabled>
                        <button id="btn-send" class="bg-indigo-600 text-white px-8 rounded-2xl font-black text-xs hover:bg-indigo-500 transition-all disabled:opacity-30" disabled>ENVIAR</button>
                    </div>

                    <div id="voting-overlay" class="absolute inset-0 bg-slate-950/98 z-30 hidden flex flex-col items-center justify-center p-10 text-center">
                        <div class="mb-8">
                            <h2 class="text-3xl font-black text-red-500 uppercase italic">Votación en Curso</h2>
                        </div>
                        <div id="voting-grid" class="grid grid-cols-2 gap-4 w-full max-w-md"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-result" class="hidden py-12 text-center space-y-8">
            <h2 id="result-title" class="text-7xl font-black italic tracking-tighter">---</h2>
            <div class="glass p-10 rounded-[3rem] max-w-lg mx-auto space-y-6">
                <p id="result-msg" class="text-xl text-slate-300 font-light leading-relaxed">---</p>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-950 p-6 rounded-3xl border border-white/5">
                        <span class="text-[10px] uppercase font-bold text-slate-500 block mb-2">Civiles</span>
                        <b id="reveal-c" class="text-2xl text-indigo-400 uppercase tracking-widest">-</b>
                    </div>
                    <div class="bg-slate-950 p-6 rounded-3xl border border-red-500/10">
                        <span class="text-[10px] uppercase font-bold text-slate-500 block mb-2">Impostor</span>
                        <b id="reveal-i" class="text-2xl text-red-500 uppercase tracking-widest">-</b>
                    </div>
                </div>
            </div>
            <button onclick="location.reload()" class="bg-slate-800 hover:bg-indigo-600 px-12 py-5 rounded-3xl font-black text-sm transition-all">NUEVA PARTIDA</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- CONFIGURACIÓN CRÍTICA ---
        // 1. REEMPLAZA ESTO CON TUS DATOS DE FIREBASE SI NO USAS EL ENTORNO ORIGINAL
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "TU_API_KEY_FIREBASE",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // 2. COLOCA AQUÍ TU API KEY DE GOOGLE AI (GEMINI)
        const geminiApiKey = "TU_API_KEY_DE_GEMINI"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = window.__app_id || 'impostor-game-v1';

        const WORDS_DB = [
            {c: "Gato", i: "Tigre"}, {c: "Youtube", i: "Twitch"}, {c: "Pizza", i: "Hamburguesa"},
            {c: "Doctor", i: "Enfermero"}, {c: "Bosque", i: "Selva"}, {c: "Oro", i: "Plata"},
            {c: "Tenedor", i: "Cuchara"}, {c: "Guitarra", i: "Violín"}, {c: "Coche", i: "Moto"}
        ];
        const BOT_NAMES = ["Gemini-Alpha", "Gemini-Beta", "Gemini-Gamma"];

        let state = { user: null, roomId: null, data: null, isProcessingAI: false };

        // UI HELPERS
        const setStatus = (msg, isError = false) => {
            const el = document.getElementById('status-text');
            if(el) {
                el.innerText = msg.toUpperCase();
                el.className = isError ? 'error-pulse font-bold' : 'text-indigo-400';
            }
        };
        const setAIDebug = (msg) => document.getElementById('ai-debug').innerText = `GEMINI: ${msg.toUpperCase()}`;
        const showView = (id) => {
            ['view-loading', 'view-setup', 'view-game', 'view-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        // AUTH
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (e) { 
                console.error(e);
                setStatus("Error de Conexión Firebase", true); 
                document.getElementById('loading-text').innerText = "Error: Configura Firebase correctamente";
            }
        }

        onAuthStateChanged(auth, u => { 
            if(u) { 
                state.user = u; 
                setStatus("Agente Online"); 
                showView('view-setup'); 
            } 
        });

        initAuth();

        // LOGICA DE JUEGO
        document.getElementById('btn-create').onclick = async () => {
            if(!geminiApiKey || geminiApiKey.includes("TU_API_KEY")) {
                alert("Debes configurar tu geminiApiKey en el código primero.");
                return;
            }

            const btn = document.getElementById('btn-create');
            btn.disabled = true;
            setStatus("Generando Red...");
            
            try {
                const name = document.getElementById('player-name').value || "Agente";
                const rId = Math.random().toString(36).substring(7).toUpperCase();
                const pair = WORDS_DB[Math.floor(Math.random() * WORDS_DB.length)];

                let players = [{ id: state.user.uid, name, isBot: false, role: 'civil', votedFor: null }];
                for(let i=0; i<3; i++) players.push({ id: `bot_${i}`, name: BOT_NAMES[i], isBot: true, role: 'civil', votedFor: null });
                
                players.sort(() => Math.random() - 0.5);
                players[Math.floor(Math.random() * players.length)].role = 'impostor';

                const room = {
                    code: rId, phase: 'words', players, history: [],
                    turnIdx: 0, words: pair, status: 'active', lastUpdate: Date.now()
                };

                await setDoc(doc(db, 'rooms', rId), room);
                state.roomId = rId;
                startRoomListener(rId);
            } catch (e) { 
                console.error(e);
                btn.disabled = false; 
                setStatus("Error al crear sala", true); 
            }
        };

        function startRoomListener(id) {
            onSnapshot(doc(db, 'rooms', id), (snap) => {
                if(!snap.exists()) return;
                state.data = snap.data();
                renderUI();
                handleGameLogic();
            });
        }

        async function handleGameLogic() {
            if(state.isProcessingAI) return;
            const d = state.data;
            if(!d || d.status !== 'active' || d.phase === 'ended') return;

            const current = d.players[d.turnIdx];

            // Turno de la IA
            if(d.phase === 'words' && current && current.isBot) {
                state.isProcessingAI = true;
                toggleAILoader(true, `${current.name} analizando...`);
                
                try {
                    const wordToDescribe = current.role === 'impostor' ? d.words.i : d.words.c;
                    const historyText = d.history.map(h => h.word).join(", ");
                    
                    const prompt = `Juego: "El Impostor". Tu palabra: "${wordToDescribe}". Historial: [${historyText}]. 
                    REGLA: Responde con UNA SOLA PALABRA relacionada pero no obvia. No uses la propia palabra. Solo la palabra, nada más.`;

                    const response = await callGeminiAPI(prompt);
                    const cleanWord = response.trim().replace(/[^\w]/g, '').split(/\s+/)[0];

                    if(cleanWord) {
                        await pushWord(current.id, cleanWord);
                    }
                } catch (e) {
                    console.error("Gemini Error:", e);
                    setAIDebug("FALLO DE API");
                } finally {
                    state.isProcessingAI = false;
                    toggleAILoader(false);
                }
            }

            // Votación de la IA
            if(d.phase === 'voting') {
                const botToVote = d.players.find(p => p.isBot && !p.votedFor);
                if(botToVote) {
                    state.isProcessingAI = true;
                    setTimeout(async () => {
                        const candidates = d.players.filter(p => p.id !== botToVote.id);
                        const target = candidates[Math.floor(Math.random() * candidates.length)].id;
                        await pushVote(botToVote.id, target);
                        state.isProcessingAI = false;
                    }, 1500);
                }
            }
        }

        async function callGeminiAPI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const json = await res.json();
            return json.candidates?.[0]?.content?.parts?.[0]?.text || "Misterio";
        }

        async function pushWord(pid, word) {
            const ref = doc(db, 'rooms', state.roomId);
            const snap = await getDoc(ref);
            const d = snap.data();
            const history = [...d.history, { playerId: pid, word }];
            let turnIdx = d.turnIdx + 1;
            let phase = d.phase;
            if(turnIdx >= d.players.length) { turnIdx = 0; phase = 'voting'; }
            await updateDoc(ref, { history, turnIdx, phase, lastUpdate: Date.now() });
        }

        async function pushVote(voterId, targetId) {
            const ref = doc(db, 'rooms', state.roomId);
            const snap = await getDoc(ref);
            const d = snap.data();
            const players = d.players.map(p => p.id === voterId ? {...p, votedFor: targetId} : p);
            const allVoted = players.every(p => p.votedFor);
            await updateDoc(ref, { players, phase: allVoted ? 'ended' : d.phase });
        }

        function renderUI() {
            const d = state.data;
            if(!d) return;
            showView('view-game');

            document.getElementById('player-list').innerHTML = d.players.map((p, i) => `
                <div class="flex justify-between items-center p-4 rounded-2xl transition-all ${d.turnIdx === i && d.phase === 'words' ? 'turn-active' : 'bg-slate-900/50 border border-white/5'}">
                    <div class="flex items-center gap-3">
                        <div class="h-1.5 w-1.5 rounded-full ${p.isBot ? 'bg-indigo-500' : 'bg-emerald-500'}"></div>
                        <span class="text-xs font-bold ${p.id === state.user.uid ? 'text-indigo-400' : 'text-slate-300'}">${p.name}</span>
                    </div>
                    ${p.votedFor ? '<span class="text-[8px] bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded font-bold">VOTÓ</span>' : ''}
                </div>
            `).join('');

            document.getElementById('chat-feed').innerHTML = d.history.map(h => {
                const p = d.players.find(pl => pl.id === h.playerId);
                const isMe = h.playerId === state.user.uid;
                return `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <span class="text-[8px] text-slate-500 mb-1 px-2 uppercase">${p?.name}</span>
                        <div class="${isMe ? 'bg-indigo-600' : 'bg-slate-800'} px-5 py-2.5 rounded-2xl text-sm font-bold border border-white/5">
                            ${h.word}
                        </div>
                    </div>
                `;
            }).join('');
            
            const feed = document.getElementById('chat-feed');
            feed.scrollTop = feed.scrollHeight;

            const me = d.players.find(p => p.id === state.user.uid);
            document.getElementById('role-reveal').innerText = me.role;
            document.getElementById('role-word').innerText = `Tu Palabra: ${me.role === 'impostor' ? d.words.i : d.words.c}`;

            const isMyTurn = d.phase === 'words' && d.players[d.turnIdx].id === state.user.uid;
            document.getElementById('word-input').disabled = !isMyTurn;
            document.getElementById('btn-send').disabled = !isMyTurn;

            const vOverlay = document.getElementById('voting-overlay');
            if(d.phase === 'voting' && me && !me.votedFor) {
                vOverlay.classList.remove('hidden');
                document.getElementById('voting-grid').innerHTML = d.players
                    .filter(p => p.id !== state.user.uid)
                    .map(p => `
                        <button onclick="window.votar('${p.id}')" class="bg-slate-900 border border-white/10 p-5 rounded-3xl hover:border-red-500 transition-all font-black text-xs uppercase text-slate-400">
                            ${p.name}
                        </button>
                    `).join('');
            } else { vOverlay.classList.add('hidden'); }

            if(d.phase === 'ended') renderResults(d);
        }

        window.votar = (tid) => pushVote(state.user.uid, tid);

        function renderResults(d) {
            showView('view-result');
            const votes = {};
            d.players.forEach(p => { if(p.votedFor) votes[p.votedFor] = (votes[p.votedFor] || 0) + 1; });
            
            let targetId = d.players[0].id;
            let maxVotes = -1;
            Object.entries(votes).forEach(([id, v]) => { if(v > maxVotes) { maxVotes = v; targetId = id; } });
            
            const accused = d.players.find(p => p.id === targetId);
            const win = accused.role === 'impostor';

            document.getElementById('result-title').innerText = win ? "VICTORIA CIVIL" : "VICTORIA IMPOSTOR";
            document.getElementById('result-title').className = win ? "text-6xl font-black text-indigo-500 italic" : "text-6xl font-black text-red-600 italic";
            document.getElementById('result-msg').innerText = `El grupo expulsó a ${accused.name}.`;
            document.getElementById('reveal-c').innerText = d.words.c;
            document.getElementById('reveal-i').innerText = d.words.i;
        }

        document.getElementById('btn-send').onclick = () => {
            const input = document.getElementById('word-input');
            const val = input.value.trim();
            if(val) { pushWord(state.user.uid, val); input.value = ''; }
        };

        function toggleAILoader(show, msg) {
            const el = document.getElementById('ai-status-indicator');
            if(show) {
                el.classList.remove('hidden');
                document.getElementById('ai-status-msg').innerText = msg;
            } else { el.classList.add('hidden'); }
        }
    </script>
</body>
</html>
